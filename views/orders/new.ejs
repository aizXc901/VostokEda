<h2>Create New Order</h2>

<form method="POST" action="/orders" id="orderForm">
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="eventId" class="form-label">Event</label>
            <select class="form-select" id="eventId" name="eventId" required>
                <option value="">Select an event</option>
                <% events.forEach(event => { %>
                    <option value="<%= event.id %>"><%= event.name %> - <%= new Date(event.date).toLocaleDateString() %></option>
                <% }); %>
            </select>
        </div>
        <div class="col-md-6">
            <label for="orderNumber" class="form-label">Order Number</label>
            <input type="text" class="form-control" id="orderNumber" name="orderNumber" required>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5>Order Items</h5>
            <button type="button" class="btn btn-success btn-sm float-end" onclick="addOrderItem()">Add Item</button>
        </div>
        <div class="card-body">
            <div id="orderItemsContainer">
                <!-- Dynamic order items will be added here -->
                <div class="row order-item-row g-2 mb-2" id="orderItemTemplate" style="display: none;">
                    <div class="col-md-4">
                        <select class="form-select nomenclature-select" name="nomenclatureIds[]" required>
                            <option value="">Select item</option>
                            <% nomenclatures.forEach(item => { %>
                                <option value="<%= item.id %>" data-category-id="<%= item.costCategoryId %>">
                                    <%= item.name %> (<%= item.CostCategory.name %>)
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control quantity-input" name="quantities[]" min="1" placeholder="Qty" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" step="0.01" class="form-control price-input" name="prices[]" min="0" placeholder="Price" required>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select supplier-select" name="supplierIds[]" required>
                            <option value="">Select supplier</option>
                            <% suppliers.forEach(supplier => { %>
                                <option value="<%= supplier.id %>" data-category-id="<%= supplier.costCategoryId %>">
                                    <%= supplier.name %> (<%= supplier.CostCategory.name %>)
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm remove-item-btn" onclick="removeOrderItem(this)">X</button>
                    </div>
                </div>
                
                <!-- Initial empty row -->
                <div class="row order-item-row g-2 mb-2">
                    <div class="col-md-4">
                        <select class="form-select nomenclature-select" name="nomenclatureIds[]" required>
                            <option value="">Select item</option>
                            <% nomenclatures.forEach(item => { %>
                                <option value="<%= item.id %>" data-category-id="<%= item.costCategoryId %>">
                                    <%= item.name %> (<%= item.CostCategory.name %>)
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control quantity-input" name="quantities[]" min="1" placeholder="Qty" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" step="0.01" class="form-control price-input" name="prices[]" min="0" placeholder="Price" required>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select supplier-select" name="supplierIds[]" required>
                            <option value="">Select supplier</option>
                            <% suppliers.forEach(supplier => { %>
                                <option value="<%= supplier.id %>" data-category-id="<%= supplier.costCategoryId %>">
                                    <%= supplier.name %> (<%= supplier.CostCategory.name %>)
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm remove-item-btn" onclick="removeOrderItem(this)" style="display:none;">X</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-success">Save Order</button>
        <a href="/orders" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
    function addOrderItem() {
        const container = document.getElementById('orderItemsContainer');
        const template = document.getElementById('orderItemTemplate');
        
        const newRow = template.cloneNode(true);
        newRow.style.display = 'flex';
        newRow.id = '';
        
        // Show the remove button for new rows
        const removeBtn = newRow.querySelector('.remove-item-btn');
        removeBtn.style.display = 'block';
        
        // Clear values
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        
        container.appendChild(newRow);
    }
    
    function removeOrderItem(button) {
        const row = button.closest('.order-item-row');
        row.remove();
    }
    
    // Filter suppliers based on selected nomenclature category
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('nomenclature-select')) {
            const nomenclatureSelect = e.target;
            const supplierSelect = nomenclatureSelect.closest('.order-item-row').querySelector('.supplier-select');
            const selectedNomenclatureOption = nomenclatureSelect.options[nomenclatureSelect.selectedIndex];
            const categoryId = selectedNomenclatureOption.dataset.categoryId;
            
            // Show only suppliers that match the category
            Array.from(supplierSelect.options).forEach(option => {
                if (option.value === '') {
                    option.selected = true;
                } else if (categoryId && option.dataset.categoryId == categoryId) {
                    option.style.display = 'block';
                } else if (!categoryId) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
    });
</script>